#!/usr/bin/env bash
#
# tms - Tmux Session Manager
# A fzf-based TUI for managing project windows within tmux
# Theme: Tokyo Night
#

set -euo pipefail

# Configuration paths
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/tmux-sessions"
PROJECTS_FILE="$CONFIG_DIR/projects.conf"
LAYOUTS_DIR="$CONFIG_DIR/layouts"
LASTUSED_FILE="$CONFIG_DIR/.lastused.conf"

# ANSI color codes (Tokyo Night)
C_RESET='\033[0m'
C_BOLD='\033[1m'
C_CYAN='\033[38;2;125;207;255m'
C_GREEN='\033[38;2;158;206;106m'
C_YELLOW='\033[38;2;224;175;104m'
C_RED='\033[38;2;247;118;142m'
C_BLUE='\033[38;2;122;162;247m'
C_COMMENT='\033[38;2;86;95;137m'

# FZF colors
FZF_COLORS="bg:#1a1b26,bg+:#292e42,fg:#c0caf5,fg+:#c0caf5,hl:#7aa2f7,hl+:#7dcfff,info:#9ece6a,prompt:#7aa2f7,pointer:#f7768e,marker:#9ece6a,spinner:#bb9af7,header:#565f89,border:#292e42"

# Check dependencies
check_deps() {
  command -v fzf >/dev/null 2>&1 || { echo -e "${C_RED}Error: fzf not found${C_RESET}" >&2; exit 1; }
  command -v tmux >/dev/null 2>&1 || { echo -e "${C_RED}Error: tmux not found${C_RESET}" >&2; exit 1; }
  command -v yq >/dev/null 2>&1 || { echo -e "${C_RED}Error: yq not found${C_RESET}" >&2; exit 1; }
}

# Check if config exists
check_config() {
  if [[ ! -f "$PROJECTS_FILE" ]]; then
    echo -e "${C_YELLOW}Config not found at $PROJECTS_FILE${C_RESET}" >&2
    echo "Run 'tms init' to create one" >&2
    exit 1
  fi
}

# Get formatted project list for fzf
get_project_list() {
  local active_windows=""
  [[ -n "${TMUX:-}" ]] && active_windows=$(tmux list-windows -F "#{window_name}" 2>/dev/null | tr '\n' '|')

  awk -F'|' -v active="$active_windows" -v lastused_file="$LASTUSED_FILE" '
    BEGIN {
      count = 0
      while ((getline line < lastused_file) > 0) {
        if (split(line, parts, "|") == 2) { ts[parts[2]] = parts[1] }
      }
      close(lastused_file)
    }
    /^#/ || /^$/ { next }
    {
      name = $1; path = $2
      if (name == "") next
      timestamp = (name in ts) ? ts[name] : 0
      is_active = (index(active, name "|") > 0) ? 1 : 0
      count++
      data[count] = timestamp "|" is_active "|" name "|" path
    }
    END {
      for (i = 1; i <= count; i++) {
        for (j = i + 1; j <= count; j++) {
          split(data[i], a, "|"); split(data[j], b, "|")
          if (b[1] > a[1]) { tmp = data[i]; data[i] = data[j]; data[j] = tmp }
        }
      }
      for (i = 1; i <= count; i++) {
        split(data[i], parts, "|")
        if (parts[2]) printf "● %-18s  %s\n", parts[3], parts[4]
        else printf "  %-18s  %s\n", parts[3], parts[4]
      }
    }
  ' "$PROJECTS_FILE"
}

# Get project info
get_project_path() {
  local name="$1"
  local path
  path=$(awk -F'|' -v n="$name" '$1 == n { print $2; exit }' "$PROJECTS_FILE")
  echo "${path/#\~/$HOME}"
}

get_project_layout() {
  local name="$1"
  awk -F'|' -v n="$name" '$1 == n { print ($3 ? $3 : "default"); exit }' "$PROJECTS_FILE"
}

# Update last used timestamp
update_lastused() {
  local name="$1"
  mkdir -p "$CONFIG_DIR"
  if [[ -f "$LASTUSED_FILE" ]]; then
    grep -v "|${name}$" "$LASTUSED_FILE" 2>/dev/null > "${LASTUSED_FILE}.tmp" || true
    mv "${LASTUSED_FILE}.tmp" "$LASTUSED_FILE"
  fi
  echo "$(date +%s)|${name}" >> "$LASTUSED_FILE"
}

# Check if window exists
window_exists() {
  local name="$1"
  tmux list-windows -F "#{window_name}" 2>/dev/null | grep -q "^${name}$"
}

# Apply layout to window - deterministic: create panes first, then run commands
apply_layout() {
  local project="$1"
  local layout_name="$2"
  local project_path="$3"
  local layout_file="$LAYOUTS_DIR/${layout_name}.yaml"

  # Check for project-specific layout first
  [[ -f "$LAYOUTS_DIR/${project}.yaml" ]] && layout_file="$LAYOUTS_DIR/${project}.yaml"
  [[ ! -f "$layout_file" ]] && layout_file="$LAYOUTS_DIR/default.yaml"
  [[ ! -f "$layout_file" ]] && return 0

  local num_panes focus_pane_id=""
  num_panes=$(yq -r '.windows[0].panes | length' "$layout_file")

  # Arrays to store pane info - use pane_id (stable) not pane_index (changes)
  local -a pane_commands=()
  local -a pane_ids=()

  # Get pane-base-index for targeting the first pane
  local pane_base
  pane_base=$(tmux show-options -gv pane-base-index 2>/dev/null || echo "0")

  # Phase 1: Create all panes
  for ((p = 0; p < num_panes; p++)); do
    local split_type size target

    if [[ $p -eq 0 ]]; then
      # First pane already exists - get its stable pane_id using window.pane_base target
      pane_ids+=("$(tmux list-panes -t "${project}" -F '#{pane_id}' | head -1)")
    else
      split_type=$(yq -r ".windows[0].panes[$p].split // \"horizontal\"" "$layout_file")
      size=$(yq -r ".windows[0].panes[$p].size // \"50%\"" "$layout_file")
      target=$(yq -r ".windows[0].panes[$p].target // \"\"" "$layout_file")

      # Determine which pane to split - use pane_id from our array
      local split_target
      if [[ -n "$target" && "$target" != "null" ]]; then
        # Target refers to pane definition index (0, 1, 2...), look up actual pane_id
        split_target="${pane_ids[$target]}"
      else
        # Default: split the last created pane
        local last_idx=$((${#pane_ids[@]} - 1))
        split_target="${pane_ids[$last_idx]}"
      fi

      local new_pane_id
      if [[ "$split_type" == "vertical" ]]; then
        new_pane_id=$(tmux split-window -t "$split_target" -v -l "${size%\%}%" -c "$project_path" -P -F "#{pane_id}")
      else
        new_pane_id=$(tmux split-window -t "$split_target" -h -l "${size%\%}%" -c "$project_path" -P -F "#{pane_id}")
      fi
      pane_ids+=("$new_pane_id")
    fi

    # Store command for this pane
    local cmd
    cmd=$(yq -r ".windows[0].panes[$p].command // \"\"" "$layout_file")
    pane_commands+=("$cmd")

    # Check if this pane should be focused
    local should_focus
    should_focus=$(yq -r ".windows[0].panes[$p].focus // false" "$layout_file")
    [[ "$should_focus" == "true" ]] && focus_pane_id="${pane_ids[$p]}"
  done

  # Phase 2: Apply commands to panes (after all panes exist)
  for ((p = 0; p < num_panes; p++)); do
    local cmd="${pane_commands[$p]}"
    if [[ -n "$cmd" && "$cmd" != "null" && "$cmd" != "" ]]; then
      tmux send-keys -t "${pane_ids[$p]}" "$cmd" Enter
    fi
  done

  # Phase 3: Focus the designated pane
  if [[ -n "$focus_pane_id" ]]; then
    tmux select-pane -t "${focus_pane_id}"
  else
    tmux select-pane -t "${pane_ids[0]}"
  fi
}

# Start/switch to a project
start_project() {
  local name="$1"
  local path layout
  path=$(get_project_path "$name")
  layout=$(get_project_layout "$name")

  [[ -z "$path" ]] && { echo -e "${C_RED}✗ Project '$name' not found${C_RESET}" >&2; return 1; }
  [[ ! -d "$path" ]] && { echo -e "${C_RED}✗ Path '$path' does not exist${C_RESET}" >&2; return 1; }

  update_lastused "$name"

  if [[ -z "${TMUX:-}" ]]; then
    # Not in tmux - create new session
    tmux new-session -s "$name" -c "$path"
    return 0
  fi

  # Already in tmux
  if window_exists "$name"; then
    tmux select-window -t "$name"
    return 0
  fi

  # Create new window and apply layout
  tmux new-window -n "$name" -c "$path"
  apply_layout "$name" "$layout" "$path"
}

# Stop/close a project window
stop_project() {
  local name="$1"
  [[ -z "${TMUX:-}" ]] && { echo -e "${C_RED}✗ Not inside tmux${C_RESET}" >&2; return 1; }

  if window_exists "$name"; then
    tmux kill-window -t "$name" 2>/dev/null || true
    echo -e "${C_GREEN}✓ Closed '$name'${C_RESET}"
  else
    echo -e "${C_YELLOW}○ '$name' is not open${C_RESET}"
  fi
}

# Add a new project
add_project() {
  local name="${1:-}" path="${2:-}"

  [[ -z "$name" ]] && { echo -ne "${C_CYAN}Project name: ${C_RESET}"; read -r name; }
  [[ -z "$path" ]] && { echo -ne "${C_CYAN}Project path: ${C_RESET}"; read -r path; }

  local expanded_path="${path/#\~/$HOME}"

  if [[ ! -d "$expanded_path" ]]; then
    echo -e "${C_YELLOW}⚠ Path '$path' does not exist${C_RESET}"
    echo -ne "${C_COMMENT}Add anyway? [y/N] ${C_RESET}"
    read -r confirm
    [[ "$confirm" != [yY] ]] && return 1
  fi

  grep -q "^${name}|" "$PROJECTS_FILE" 2>/dev/null && { echo -e "${C_RED}✗ Project '$name' already exists${C_RESET}" >&2; return 1; }

  local store_path="${path}"
  [[ "$path" == "$HOME"* ]] && store_path="~${path#$HOME}"

  echo "${name}|${store_path}|default" >> "$PROJECTS_FILE"
  echo -e "${C_GREEN}✓ Added '$name'${C_RESET}"
}

# Remove a project
remove_project() {
  local force=false name=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -y|--yes|--force) force=true; shift ;;
      *) name="$1"; shift ;;
    esac
  done

  # Trim whitespace from name
  name="${name#"${name%%[![:space:]]*}"}"
  name="${name%"${name##*[![:space:]]}"}"

  if [[ -z "$name" ]]; then
    if [[ "$force" == true ]]; then
      echo -e "${C_RED}✗ No project name provided${C_RESET}" >&2
      return 1
    fi
    name=$(awk -F'|' '/^[^#]/ && NF { print $1 }' "$PROJECTS_FILE" | fzf --prompt="Remove › " --height=40% --reverse --color="$FZF_COLORS")
    [[ -z "$name" ]] && return 0
  fi

  if [[ "$force" != true ]]; then
    echo -ne "${C_YELLOW}Remove '$name'? [y/N] ${C_RESET}"
    read -r confirm
    [[ "$confirm" != [yY] ]] && return 0
  fi

  grep -v "^${name}|" "$PROJECTS_FILE" > "${PROJECTS_FILE}.tmp"
  mv "${PROJECTS_FILE}.tmp" "$PROJECTS_FILE"
  echo -e "${C_GREEN}✓ Removed '$name'${C_RESET}"
}

# List all projects
list_projects() {
  local active_windows=""
  [[ -n "${TMUX:-}" ]] && active_windows=$(tmux list-windows -F "#{window_name}" 2>/dev/null | tr '\n' '|')

  echo -e "${C_BOLD}${C_BLUE}Projects${C_RESET}"
  echo -e "${C_COMMENT}─────────────────────────────────────────${C_RESET}"

  awk -F'|' -v active="$active_windows" '
    /^#/ || /^$/ { next }
    {
      name = $1; path = $2
      if (index(active, name "|") > 0)
        printf "\033[38;2;158;206;106m●\033[0m \033[38;2;125;207;255m%s\033[0m  \033[38;2;86;95;137m%s\033[0m\n", name, path
      else
        printf "\033[38;2;86;95;137m  %s  %s\033[0m\n", name, path
    }
  ' "$PROJECTS_FILE"
  echo ""
}

# Edit config/layouts
edit_config() { ${EDITOR:-vim} "$PROJECTS_FILE"; }
edit_layouts() { ${EDITOR:-vim} "$LAYOUTS_DIR"; }

# Initialize config
init_config() {
  mkdir -p "$CONFIG_DIR" "$LAYOUTS_DIR"

  if [[ ! -f "$PROJECTS_FILE" ]]; then
    cat > "$PROJECTS_FILE" << 'EOF'
# TMS projects configuration
# Format: name|path|layout
EOF
    echo -e "${C_GREEN}✓ Created config${C_RESET}"
  else
    echo -e "${C_YELLOW}○ Config already exists${C_RESET}"
  fi

  if [[ ! -f "$LAYOUTS_DIR/default.yaml" ]]; then
    cat > "$LAYOUTS_DIR/default.yaml" << 'EOF'
# Default layout: shell (20%) | nvim (80%)
windows:
  - name: main
    panes:
      - command: ""
      - split: horizontal
        size: 80%
        command: "nvim"
        focus: true
EOF
    echo -e "${C_GREEN}✓ Created default layout${C_RESET}"
  fi
}

# Main TUI
main_tui() {
  check_config

  local help_short=$'? help\n '
  local help_full=$'j/k/C-j/C-k nav | enter open\nC-d close | C-a add | C-e edit | C-x rm | q quit\n '
  local toggle_file="/tmp/tms_help_$$"

  local result
  result=$(get_project_list | fzf \
    --ansi \
    --disabled \
    --pointer="▶" \
    --header="$help_short" \
    --height=100% \
    --reverse \
    --color="$FZF_COLORS" \
    --bind="j:down,k:up,J:down,K:up,ctrl-j:down,ctrl-k:up" \
    --bind="ctrl-p:abort,q:abort" \
    --bind="ctrl-d:execute-silent(tms stop \$(echo {} | sed 's/^[● ]*//' | awk '{print \$1}'))+reload(tms --get-list)" \
    --bind="ctrl-x:execute(tms remove --yes \$(echo {} | sed 's/^[● ]*//' | awk '{print \$1}'))+reload(tms --get-list)" \
    --bind="ctrl-a:execute(tms add)+reload(tms --get-list)" \
    --bind="ctrl-e:execute(tms edit)+reload(tms --get-list)" \
    --bind="?:transform:[[ -f $toggle_file ]] && { rm $toggle_file; echo \"change-header($help_short)\"; } || { touch $toggle_file; echo \"change-header($help_full)\"; }" \
    2>/dev/null) || true

  rm -f "$toggle_file"
  [[ -z "$result" ]] && return 0

  # Extract project name (second field after bullet/space indicator)
  local project
  project=$(echo "$result" | sed 's/^[● ]*//' | awk '{print $1}')
  [[ -n "$project" ]] && start_project "$project"
}

# Show help
show_help() {
  cat << EOF
${C_BOLD}${C_BLUE}tms${C_RESET} ${C_COMMENT}- Tmux Session Manager${C_RESET}

${C_BOLD}Usage${C_RESET}
  tms              Interactive project picker
  tms start NAME   Open project window
  tms stop NAME    Close project window
  tms add          Add new project
  tms remove       Remove project
  tms list         List all projects
  tms edit         Edit projects config
  tms layouts      Edit layout templates
  tms init         Initialize for new machine

${C_BOLD}Config${C_RESET}
  $PROJECTS_FILE
  $LAYOUTS_DIR/
EOF
}

# Main entry point
main() {
  check_deps

  local cmd="${1:-}"
  shift || true

  case "$cmd" in
    "--get-list") check_config; get_project_list ;;
    ""|"tui") main_tui ;;
    "start"|"s"|"open"|"o")
      check_config
      if [[ -n "${1:-}" ]]; then
        start_project "$1"
      else
        local project
        project=$(awk -F'|' '/^[^#]/ && NF { print $1 }' "$PROJECTS_FILE" | fzf --prompt="Open › " --height=40% --reverse --color="$FZF_COLORS" --bind="j:down,k:up")
        [[ -n "$project" ]] && start_project "$project"
      fi
      ;;
    "stop"|"k"|"close"|"c")
      check_config
      if [[ -n "${1:-}" ]]; then
        stop_project "$1"
      else
        local project
        project=$(tmux list-windows -F "#{window_name}" 2>/dev/null | fzf --prompt="Close › " --height=40% --reverse --color="$FZF_COLORS" --bind="j:down,k:up")
        [[ -n "$project" ]] && stop_project "$project"
      fi
      ;;
    "add"|"a") check_config; add_project "${1:-}" "${2:-}" ;;
    "remove"|"rm"|"r") check_config; remove_project "$@" ;;
    "list"|"ls"|"l") check_config; list_projects ;;
    "edit"|"e") check_config; edit_config ;;
    "layouts"|"lay") check_config; edit_layouts ;;
    "init"|"i") init_config ;;
    "help"|"h"|"-h"|"--help") show_help ;;
    *) echo -e "${C_RED}Unknown command: $cmd${C_RESET}" >&2; show_help; exit 1 ;;
  esac
}

main "$@"
